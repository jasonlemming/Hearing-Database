{% extends "admin_base.html" %}

{% block title %}Admin Dashboard - System Monitoring{% endblock %}

{% block head %}
<style>
    /* Status Banner Styling */
    .status-banner {
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        border-left: 5px solid;
    }
    .status-banner.healthy {
        background-color: #d4edda;
        border-color: #28a745;
    }
    .status-banner.degraded {
        background-color: #fff3cd;
        border-color: #ffc107;
    }
    .status-banner.unhealthy {
        background-color: #f8d7da;
        border-color: #dc3545;
    }
    .status-icon {
        font-size: 2rem;
        margin-right: 1rem;
    }

    /* Timeline Visualization */
    .timeline-dots {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin: 1rem 0;
    }
    .timeline-dot {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        cursor: pointer;
        transition: transform 0.2s;
    }
    .timeline-dot:hover {
        transform: scale(1.3);
    }
    .timeline-dot.success {
        background-color: #28a745;
    }
    .timeline-dot.failed {
        background-color: #dc3545;
    }

    /* Metric Cards */
    .metric-card {
        text-align: center;
        padding: 1rem;
    }
    .metric-value {
        font-size: 2rem;
        font-weight: bold;
        color: #2c3e50;
    }
    .metric-label {
        font-size: 0.9rem;
        color: #6c757d;
        text-transform: uppercase;
    }

    /* Expandable Log Viewer */
    .log-entry {
        border-left: 3px solid #dee2e6;
        padding-left: 1rem;
        margin-bottom: 1rem;
    }
    .log-entry.success {
        border-left-color: #28a745;
    }
    .log-entry.failed {
        border-left-color: #dc3545;
    }
    .log-header {
        cursor: pointer;
        user-select: none;
    }
    .log-header:hover {
        background-color: #f8f9fa;
    }
    .log-details {
        background-color: #f8f9fa;
        border-radius: 4px;
        padding: 1rem;
        margin-top: 0.5rem;
    }
    .data-flow {
        font-family: 'Courier New', monospace;
        background-color: #fff;
        padding: 0.5rem;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }

    /* Phase 2.3 Metrics */
    .phase-metric {
        background-color: #e7f3ff;
        padding: 0.75rem;
        border-radius: 4px;
        margin-bottom: 0.5rem;
        border-left: 3px solid #007bff;
    }
    .anomaly-badge {
        background-color: #ffc107;
        color: #000;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.85rem;
    }

    /* Loading States */
    .loading-skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        border-radius: 4px;
        height: 20px;
    }
    @keyframes loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    /* Countdown Timer */
    .countdown {
        font-family: 'Courier New', monospace;
        font-size: 1.1rem;
        color: #007bff;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-tachometer-alt me-3"></i>
            Admin Dashboard
        </h1>
    </div>
</div>

<!-- System Status Banner -->
<div id="statusBanner" class="status-banner healthy">
    <div class="d-flex align-items-center">
        <div class="status-icon">
            <i id="statusIcon" class="fas fa-check-circle text-success"></i>
        </div>
        <div class="flex-grow-1">
            <h4 id="statusText" class="mb-1">System Healthy</h4>
            <div class="row">
                <div class="col-md-6">
                    <strong>Last Update:</strong> <span id="lastUpdateTime">Loading...</span>
                </div>
                <div class="col-md-6">
                    <strong>Next Update:</strong> <span id="nextUpdateTime" class="countdown">Loading...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Update Timeline Card -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-history me-2"></i>
                    Update Timeline (Last 7 Days)
                </h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value" id="successRate">--%</div>
                            <div class="metric-label">Success Rate</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value" id="totalRuns">--</div>
                            <div class="metric-label">Total Runs</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value" id="avgDuration">--s</div>
                            <div class="metric-label">Avg Duration</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value text-success" id="successfulRuns">--</div>
                            <div class="metric-label">Successful</div>
                        </div>
                    </div>
                </div>

                <div class="timeline-dots" id="timelineDots">
                    <!-- Timeline dots will be populated by JavaScript -->
                    <div class="loading-skeleton" style="width: 100%; height: 30px;"></div>
                </div>

                <div class="text-muted small mt-2">
                    <i class="fas fa-info-circle me-1"></i>
                    Hover over dots to see update details. Green = success, Red = failed.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Phase 2.3 Metrics Card -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-rocket me-2"></i>
                    Phase 2.3 Metrics
                </h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="togglePhase23Details()">
                    <i class="fas fa-chevron-down" id="phase23Toggle"></i>
                </button>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Batch Processing -->
                    <div class="col-md-6">
                        <div class="phase-metric">
                            <h6>
                                <i class="fas fa-layer-group me-2"></i>
                                Batch Processing
                            </h6>
                            <div class="mt-2">
                                <strong>Success Rate:</strong>
                                <span id="batchSuccessRate" class="text-success">--%</span>
                            </div>
                            <div>
                                <strong>Batch Size:</strong>
                                <span id="batchSize">50</span> hearings
                            </div>
                            <div>
                                <strong>Last Batch:</strong>
                                <span id="lastBatchInfo">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- Historical Validation -->
                    <div class="col-md-6">
                        <div class="phase-metric">
                            <h6>
                                <i class="fas fa-chart-line me-2"></i>
                                Historical Validation
                            </h6>
                            <div class="mt-2">
                                <strong>Anomalies (7 days):</strong>
                                <span id="anomalyCount">--</span>
                            </div>
                            <div id="anomalyAlert" class="d-none mt-2">
                                <span class="anomaly-badge">
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    Alert Triggered
                                </span>
                            </div>
                            <div id="noAnomalies" class="text-success mt-2">
                                <i class="fas fa-check-circle me-1"></i>
                                No anomalies detected
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Technical Details (Collapsible) -->
                <div id="phase23Details" class="collapse mt-3">
                    <hr>
                    <h6 class="text-muted">Technical Details</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <small>
                                <strong>Total Batches (7d):</strong> <span id="totalBatches">--</span><br>
                                <strong>Failed Batches:</strong> <span id="failedBatches">--</span><br>
                            </small>
                        </div>
                        <div class="col-md-6">
                            <small>
                                <strong>Z-Score Threshold:</strong> 3.0<br>
                                <strong>Historical Window:</strong> 30 days<br>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Updates Log -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list me-2"></i>
                    Recent Updates
                </h5>
            </div>
            <div class="card-body">
                <div id="recentUpdates">
                    <!-- Update entries will be populated by JavaScript -->
                    <div class="loading-skeleton mb-2"></div>
                    <div class="loading-skeleton mb-2"></div>
                    <div class="loading-skeleton mb-2"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Manual Update Controls -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-play-circle me-2"></i>
                    Manual Update Controls
                </h5>
            </div>
            <div class="card-body">
                <form id="manualUpdateForm">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="lookbackDays" class="form-label">
                                Lookback Days: <span id="lookbackValue">7</span>
                            </label>
                            <input type="range" class="form-range" id="lookbackDays"
                                   min="1" max="30" value="7"
                                   oninput="document.getElementById('lookbackValue').textContent = this.value">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Options</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="dryRun">
                                <label class="form-check-label" for="dryRun">
                                    Dry Run (no changes)
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <button type="submit" class="btn btn-primary" id="startUpdateBtn">
                            <i class="fas fa-play me-2"></i>
                            Start Manual Update
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="refreshDashboard()">
                            <i class="fas fa-sync me-2"></i>
                            Refresh Dashboard
                        </button>
                    </div>
                </form>

                <!-- Live Progress (hidden until update starts) -->
                <div id="liveProgress" class="d-none mt-4">
                    <hr>
                    <h6>Update in Progress...</h6>
                    <div class="progress">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                             role="progressbar" style="width: 0%"></div>
                    </div>
                    <div id="progressStats" class="mt-2 small text-muted"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scheduled Tasks -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-clock me-2"></i>
                    Scheduled Tasks
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Schedule</th>
                                <th>Next Run</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="scheduledTasksTable">
                            <tr>
                                <td colspan="5" class="text-center text-muted">Loading schedules...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Global state
let currentTaskId = null;
let updateInterval = null;

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadSystemHealth();
    loadTimeline();
    loadPhase23Metrics();
    loadRecentUpdates();
    loadScheduledTasks();

    // Auto-refresh every 30 seconds
    setInterval(function() {
        loadSystemHealth();
        loadTimeline();
        loadPhase23Metrics();
    }, 30000);

    // Setup manual update form
    document.getElementById('manualUpdateForm').addEventListener('submit', startManualUpdate);
});

// Load system health status
async function loadSystemHealth() {
    try {
        const response = await fetch('/admin/api/system-health');
        const data = await response.json();

        // Update status banner
        const banner = document.getElementById('statusBanner');
        const icon = document.getElementById('statusIcon');
        const statusText = document.getElementById('statusText');

        banner.className = 'status-banner ' + data.status;

        if (data.status === 'healthy') {
            icon.className = 'fas fa-check-circle text-success';
            statusText.textContent = 'System Healthy';
        } else if (data.status === 'degraded') {
            icon.className = 'fas fa-exclamation-triangle text-warning';
            statusText.textContent = 'System Degraded';
        } else {
            icon.className = 'fas fa-times-circle text-danger';
            statusText.textContent = 'System Unhealthy';
        }

        // Update last update time
        if (data.last_update && data.last_update.hours_ago !== null) {
            const hours = data.last_update.hours_ago;
            let timeText = '';
            if (hours < 1) {
                timeText = Math.round(hours * 60) + ' minutes ago';
            } else if (hours < 24) {
                timeText = Math.round(hours) + ' hours ago';
            } else {
                timeText = Math.round(hours / 24) + ' days ago';
            }
            document.getElementById('lastUpdateTime').textContent = timeText;
        } else {
            document.getElementById('lastUpdateTime').textContent = 'Never';
        }

        // Update next scheduled update
        if (data.next_scheduled && data.next_scheduled.hours_until !== null) {
            const hours = data.next_scheduled.hours_until;
            let timeText = '';
            if (hours < 0) {
                timeText = 'Overdue';
            } else if (hours < 1) {
                timeText = 'in ' + Math.round(hours * 60) + ' minutes';
            } else if (hours < 24) {
                timeText = 'in ' + Math.round(hours) + ' hours';
            } else {
                timeText = 'in ' + Math.round(hours / 24) + ' days';
            }
            document.getElementById('nextUpdateTime').textContent = timeText;
        } else {
            document.getElementById('nextUpdateTime').textContent = 'No schedule';
        }

    } catch (error) {
        console.error('Error loading system health:', error);
    }
}

// Load update timeline
async function loadTimeline() {
    try {
        const response = await fetch('/admin/api/timeline');
        const data = await response.json();

        // Update summary metrics
        document.getElementById('successRate').textContent = data.summary.success_rate + '%';
        document.getElementById('totalRuns').textContent = data.summary.total_runs;
        document.getElementById('avgDuration').textContent = data.summary.average_duration_seconds + 's';
        document.getElementById('successfulRuns').textContent = data.summary.successful_runs;

        // Render timeline dots
        const container = document.getElementById('timelineDots');
        container.innerHTML = '';

        data.updates.forEach(update => {
            const dot = document.createElement('div');
            dot.className = 'timeline-dot ' + (update.success ? 'success' : 'failed');
            dot.title = `${new Date(update.start_time).toLocaleString()}\n` +
                       `Checked: ${update.hearings_checked}, Updated: ${update.hearings_updated}\n` +
                       `Duration: ${Math.round(update.duration_seconds)}s`;
            dot.onclick = () => showUpdateDetails(update.log_id);
            container.appendChild(dot);
        });

    } catch (error) {
        console.error('Error loading timeline:', error);
    }
}

// Load Phase 2.3 metrics
async function loadPhase23Metrics() {
    try {
        const response = await fetch('/admin/api/phase23-metrics');
        const data = await response.json();

        // Batch processing metrics
        document.getElementById('batchSuccessRate').textContent = data.batch_processing.success_rate + '%';
        document.getElementById('batchSize').textContent = data.batch_processing.batch_size;
        document.getElementById('lastBatchInfo').textContent =
            `${data.batch_processing.last_batch_hearings} hearings`;
        document.getElementById('totalBatches').textContent = data.batch_processing.total_batches_7d;
        document.getElementById('failedBatches').textContent = data.batch_processing.failed_batches_7d;

        // Historical validation metrics
        const anomalyCount = data.historical_validation.anomalies_detected_7d;
        document.getElementById('anomalyCount').textContent = anomalyCount;

        if (data.historical_validation.alert_triggered) {
            document.getElementById('anomalyAlert').classList.remove('d-none');
            document.getElementById('noAnomalies').classList.add('d-none');
        } else {
            document.getElementById('anomalyAlert').classList.add('d-none');
            document.getElementById('noAnomalies').classList.remove('d-none');
        }

    } catch (error) {
        console.error('Error loading Phase 2.3 metrics:', error);
    }
}

// Load recent updates
async function loadRecentUpdates() {
    try {
        const response = await fetch('/admin/api/timeline');
        const data = await response.json();

        const container = document.getElementById('recentUpdates');
        container.innerHTML = '';

        // Show last 10 updates
        const recentUpdates = data.updates.slice(0, 10);

        recentUpdates.forEach(update => {
            const entry = createUpdateEntry(update);
            container.appendChild(entry);
        });

    } catch (error) {
        console.error('Error loading recent updates:', error);
    }
}

// Create update entry HTML
function createUpdateEntry(update) {
    const entry = document.createElement('div');
    entry.className = 'log-entry ' + (update.success ? 'success' : 'failed');

    const startTime = new Date(update.start_time);
    const statusIcon = update.success ?
        '<i class="fas fa-check-circle text-success"></i>' :
        '<i class="fas fa-times-circle text-danger"></i>';

    entry.innerHTML = `
        <div class="log-header" onclick="toggleUpdateDetails(${update.log_id})">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    ${statusIcon}
                    <strong>${startTime.toLocaleString()}</strong>
                    <span class="text-muted">• ${Math.round(update.duration_seconds)}s</span>
                </div>
                <div>
                    <span class="badge bg-secondary">${update.hearings_checked} checked</span>
                    <span class="badge bg-primary">${update.hearings_updated} updated</span>
                    <span class="badge bg-success">${update.hearings_added} added</span>
                    <i class="fas fa-chevron-down ms-2"></i>
                </div>
            </div>
        </div>
        <div id="details-${update.log_id}" class="collapse">
            <div class="log-details mt-2">
                <div class="loading-skeleton"></div>
            </div>
        </div>
    `;

    return entry;
}

// Toggle update details (expandable)
async function toggleUpdateDetails(logId) {
    const detailsDiv = document.getElementById(`details-${logId}`);

    if (detailsDiv.classList.contains('show')) {
        detailsDiv.classList.remove('show');
        return;
    }

    // Load full details
    try {
        const response = await fetch(`/admin/api/update-details/${logId}`);
        const data = await response.json();

        detailsDiv.querySelector('.log-details').innerHTML = `
            <h6>Data Flow</h6>
            <div class="data-flow">
                ${data.hearings_checked} checked →
                ${data.hearings_updated} updated →
                ${data.hearings_added} added
            </div>

            <h6 class="mt-3">Validation Results</h6>
            <ul>
                <li>Committees Updated: ${data.committees_updated}</li>
                <li>Witnesses Updated: ${data.witnesses_updated}</li>
                <li>API Requests: ${data.api_requests}</li>
                <li>Errors: ${data.error_count}</li>
            </ul>

            ${data.recent_hearings.length > 0 ? `
                <h6 class="mt-3">Recently Modified Hearings</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <tbody>
                            ${data.recent_hearings.slice(0, 5).map(h => `
                                <tr>
                                    <td><span class="badge bg-secondary">${h.chamber}</span></td>
                                    <td>${h.title.substring(0, 60)}...</td>
                                    <td>${h.hearing_date || 'TBD'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            ` : ''}

            <h6 class="mt-3">Phase 2.3 Metrics</h6>
            <div class="row">
                <div class="col-md-6">
                    <strong>Batch Processing:</strong><br>
                    ${data.batch_processing.batch_count} batch(es),
                    ${data.batch_processing.batches_succeeded} succeeded
                </div>
                <div class="col-md-6">
                    <strong>Historical Validation:</strong><br>
                    ${data.historical_validation.anomaly_count} anomaly(ies) detected
                </div>
            </div>
        `;

        detailsDiv.classList.add('show');

    } catch (error) {
        console.error('Error loading update details:', error);
    }
}

// Show update details in modal/expanded view
function showUpdateDetails(logId) {
    toggleUpdateDetails(logId);
}

// Load scheduled tasks
async function loadScheduledTasks() {
    try {
        const response = await fetch('/admin/api/schedules');
        const data = await response.json();

        const tbody = document.getElementById('scheduledTasksTable');
        tbody.innerHTML = '';

        if (data.schedules.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No scheduled tasks</td></tr>';
            return;
        }

        data.schedules.forEach(schedule => {
            const row = document.createElement('tr');

            const nextRun = schedule.next_run_at ?
                new Date(schedule.next_run_at).toLocaleString() :
                'Not scheduled';

            const statusBadge = schedule.is_active ?
                '<span class="badge bg-success">Active</span>' :
                '<span class="badge bg-secondary">Inactive</span>';

            row.innerHTML = `
                <td>${schedule.name}</td>
                <td><code>${schedule.schedule_cron}</code></td>
                <td>${nextRun}</td>
                <td>${statusBadge}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="toggleSchedule(${schedule.task_id})">
                        ${schedule.is_active ? 'Pause' : 'Resume'}
                    </button>
                </td>
            `;

            tbody.appendChild(row);
        });

    } catch (error) {
        console.error('Error loading scheduled tasks:', error);
    }
}

// Toggle Phase 2.3 details
function togglePhase23Details() {
    const details = document.getElementById('phase23Details');
    const toggle = document.getElementById('phase23Toggle');

    if (details.classList.contains('show')) {
        details.classList.remove('show');
        toggle.classList.remove('fa-chevron-up');
        toggle.classList.add('fa-chevron-down');
    } else {
        details.classList.add('show');
        toggle.classList.remove('fa-chevron-down');
        toggle.classList.add('fa-chevron-up');
    }
}

// Start manual update
async function startManualUpdate(e) {
    e.preventDefault();

    const lookbackDays = parseInt(document.getElementById('lookbackDays').value);
    const dryRun = document.getElementById('dryRun').checked;

    try {
        const response = await fetch('/admin/api/start-update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                lookback_days: lookbackDays,
                dry_run: dryRun,
                components: ['hearings', 'witnesses', 'committees'],
                chamber: 'both',
                mode: 'full'
            })
        });

        const data = await response.json();

        if (response.ok) {
            currentTaskId = data.task_id;
            document.getElementById('liveProgress').classList.remove('d-none');
            document.getElementById('startUpdateBtn').disabled = true;

            // Start polling for progress
            updateInterval = setInterval(pollTaskStatus, 2000);
        } else {
            alert('Error starting update: ' + data.error);
        }

    } catch (error) {
        console.error('Error starting update:', error);
        alert('Error starting update');
    }
}

// Poll task status
async function pollTaskStatus() {
    if (!currentTaskId) return;

    try {
        const response = await fetch(`/admin/api/task-status/${currentTaskId}`);
        const data = await response.json();

        // Update progress bar
        const progress = data.progress.hearings_processed || 0;
        const total = data.progress.hearings_total || 100;
        const percent = Math.round((progress / total) * 100);

        document.getElementById('progressBar').style.width = percent + '%';
        document.getElementById('progressStats').textContent =
            `${progress}/${total} hearings processed`;

        // Check if complete
        if (data.status === 'completed' || data.status === 'failed') {
            clearInterval(updateInterval);
            document.getElementById('startUpdateBtn').disabled = false;

            // Refresh dashboard
            setTimeout(refreshDashboard, 2000);

            if (data.status === 'completed') {
                alert('Update completed successfully!');
            } else {
                alert('Update failed: ' + data.error_message);
            }
        }

    } catch (error) {
        console.error('Error polling task status:', error);
    }
}

// Toggle schedule
async function toggleSchedule(taskId) {
    try {
        const response = await fetch(`/admin/api/schedules/${taskId}/toggle`, {
            method: 'POST'
        });

        if (response.ok) {
            loadScheduledTasks();
        }
    } catch (error) {
        console.error('Error toggling schedule:', error);
    }
}

// Refresh entire dashboard
function refreshDashboard() {
    loadSystemHealth();
    loadTimeline();
    loadPhase23Metrics();
    loadRecentUpdates();
    loadScheduledTasks();
}
</script>
{% endblock %}
