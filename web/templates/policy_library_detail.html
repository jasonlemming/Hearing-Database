{% extends "policy_library_base.html" %}

{% block title %}{{ document.title }}{% endblock %}

{% block head_style %}
/* Back link */
.back-link {
    font-size: 0.9rem;
    color: #6c757d;
    text-decoration: none;
    display: inline-block;
    margin-bottom: 3rem;
}

.back-link:hover {
    color: #0d6efd;
    text-decoration: none;
}

/* Document title */
.doc-title {
    font-size: 2rem;
    font-weight: 500;
    line-height: 1.3;
    margin-bottom: 1rem;
    color: #1a1a1a;
}

/* Metadata section - minimal, all in one block */
.metadata {
    font-size: 0.95rem;
    color: #6c757d;
    margin-bottom: 3rem;
    line-height: 1.8;
}

.metadata-line {
    margin-bottom: 0.5rem;
}

.metadata a {
    color: inherit;
    text-decoration: none;
    transition: color 0.2s ease;
}

.metadata a:hover {
    color: #1a1a1a;
    text-decoration: underline;
}

/* Content - Georgia serif */
.section {
    margin-bottom: 4rem;
}

.section-title {
    font-size: 1.25rem;
    font-weight: 500;
    margin-bottom: 1rem;
    color: #1a1a1a;
}

.content-preview {
    font-family: Georgia, serif;
    font-size: 1.05rem;
    line-height: 1.8;
    color: #1a1a1a;
}

.content-preview p {
    margin-bottom: 1.2rem;
}

.content-preview em {
    font-style: italic;
}

.content-preview .speaker-line {
    margin-bottom: 0.8rem;
}

.content-preview .speaker-label {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    font-weight: 600;
    font-size: 0.95rem;
    color: #0d6efd;
    letter-spacing: 0.5px;
    margin-right: 0.5rem;
}

.external-link {
    display: inline-block;
    margin-right: 1.5rem;
    margin-top: 0.5rem;
}

.show-more-btn {
    font-family: inherit;
    font-size: 0.9rem;
    padding: 0.75rem 1.5rem;
    background: #f8f9fa;
    color: #1a1a1a;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    cursor: pointer;
    margin-top: 2rem;
    transition: all 0.3s ease;
}

.show-more-btn:hover {
    background: #1a1a1a;
    color: #ffffff;
    border-color: #1a1a1a;
}

.content-preview .content-heading {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    font-weight: 500;
    color: #1a1a1a;
    margin-top: 2.5rem;
    margin-bottom: 1rem;
    line-height: 1.3;
}

.content-preview .content-h2 {
    font-size: 1.5rem;
    margin-top: 3rem;
}

.content-preview .content-h3 {
    font-size: 1.25rem;
    margin-top: 2rem;
}

.content-preview .content-h4 {
    font-size: 1.1rem;
}

.content-preview .content-h5,
.content-preview .content-h6 {
    font-size: 1rem;
}

.content-preview .content-table {
    width: 100%;
    border-collapse: collapse;
    margin: 2rem 0;
    font-size: 0.95rem;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
}

.content-preview .content-table thead th {
    background-color: #f8f9fa;
    font-weight: 600;
    text-align: left;
    padding: 0.75rem 1rem;
    border-bottom: 2px solid #dee2e6;
}

.content-preview .content-table tbody td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #e9ecef;
}

.content-preview .content-table tbody tr:hover {
    background-color: #f8f9fa;
}

.content-preview .content-table tbody tr:last-child td {
    border-bottom: none;
}

.content-preview .content-figure {
    margin: 2rem 0;
    padding: 1.5rem;
    background-color: #f8f9fa;
    border-left: 4px solid #0d6efd;
    border-radius: 4px;
}

.content-preview .figure-label {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    font-weight: 600;
    font-size: 0.95rem;
    color: #0d6efd;
    margin-bottom: 0.5rem;
}

.content-preview .figure-description {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    font-size: 0.95rem;
    color: #495057;
    line-height: 1.6;
}

.content-preview .figure-source {
    font-size: 0.85rem;
    margin-top: 0.5rem;
}

.content-preview .figure-source a {
    color: #0d6efd;
    text-decoration: none;
}

.content-preview .figure-source a:hover {
    text-decoration: underline;
}

.content-preview .interactive-chart-container {
    margin: 2rem 0;
    padding: 0;
    background-color: #ffffff;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    overflow: visible;
    min-height: 400px;
}

.content-preview .interactive-chart-container iframe {
    display: block;
    width: 100%;
    max-width: 100%;
    border: none;
    overflow: hidden;
}

/* Source badges */
.source-badge {
    display: inline-block;
    padding: 0.2rem 0.6rem;
    font-size: 0.8rem;
    font-weight: 500;
    border-radius: 3px;
    text-transform: uppercase;
    letter-spacing: 0.025em;
}

.source-badge[data-source="BROOKINGS"] {
    background: #e3f2fd;
    color: #1976d2;
}

.source-badge[data-source="SUBSTACK"] {
    background: #fff3e0;
    color: #e65100;
}

.source-badge[data-source="CRS"] {
    background: #f3e5f5;
    color: #7b1fa2;
}

.source-badge[data-source="GAO"] {
    background: #e8f5e9;
    color: #2e7d32;
}

.source-badge[data-source="UNKNOWN"] {
    background: #f5f5f5;
    color: #757575;
}

/* CRS-specific content styling */
.content-preview h1,
.content-preview h2,
.content-preview h3,
.content-preview .Heading1,
.content-preview .Heading2,
.content-preview .Heading3,
.content-preview .SummaryHeading {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    font-weight: 500;
    color: #1a1a1a;
    margin-top: 2.5rem;
    margin-bottom: 1rem;
    line-height: 1.3;
}

.content-preview h1,
.content-preview .Heading1,
.content-preview .SummaryHeading {
    font-size: 1.5rem;
    margin-top: 3rem;
}

.content-preview h2,
.content-preview .Heading2 {
    font-size: 1.25rem;
    margin-top: 2rem;
}

.content-preview h3,
.content-preview .Heading3 {
    font-size: 1.1rem;
}

/* Hide duplicate elements from CRS content */
.content-preview .ReportHeader,
.content-preview .TOC,
.content-preview .Title,
.content-preview .CoverDate,
.content-preview > div[style*="border-bottom"] {
    display: none;
}

/* CRS Tables */
.content-preview table {
    width: 100%;
    margin: 2rem 0;
    border-collapse: collapse;
    font-size: 0.95rem;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
}

.content-preview table th,
.content-preview table td {
    padding: 0.75rem 1rem;
    border: 1px solid #dee2e6;
    text-align: left;
    vertical-align: top;
}

.content-preview table th {
    background-color: #f8f9fa;
    font-weight: 600;
}

.content-preview table tbody tr:hover {
    background-color: #f8f9fa;
}

/* CRS Lists */
.content-preview ul,
.content-preview ol {
    margin-bottom: 1.2rem;
    padding-left: 2rem;
}

.content-preview li {
    margin-bottom: 0.5rem;
}

/* CRS Images */
.content-preview img {
    max-width: 100%;
    height: auto;
    margin: 2rem 0;
    border-radius: 4px;
}

.content-preview img.Figure {
    display: block;
    margin-left: auto;
    margin-right: auto;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Image fallback when image fails to load */
.content-preview img.broken-image {
    display: inline-block;
    padding: 2rem;
    background-color: #f8f9fa;
    border: 2px dashed #dee2e6;
    text-align: center;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    font-size: 0.9rem;
    color: #6c757d;
    min-height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Sticky TOC Sidebar - minimal styling */
.sticky-toc-sidebar {
    position: sticky;
    top: 20px;
    max-height: calc(100vh - 40px);
    overflow-y: auto;
    overflow-x: hidden;
}

.sticky-toc {
    background: #ffffff;
    border: 1px solid #f0f0f0;
    border-radius: 4px;
    padding: 1.5rem;
    font-size: 0.9rem;
}

.sticky-toc h2 {
    font-size: 1rem;
    font-weight: 500;
    color: #1a1a1a;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #f0f0f0;
}

.sticky-toc ul {
    list-style: none;
    padding-left: 0;
    margin-bottom: 0;
}

.sticky-toc li {
    margin-bottom: 0.25rem;
}

.sticky-toc a {
    color: #6c757d;
    text-decoration: none;
    padding: 0.25rem 0.5rem;
    display: block;
    border-radius: 4px;
    transition: all 0.2s;
    font-size: 0.85rem;
}

.sticky-toc a:hover {
    color: #0d6efd;
    background: #f8f9fa;
}

.sticky-toc a.active {
    color: #0d6efd;
    background: #f8f9fa;
    font-weight: 500;
}

.sticky-toc .TOC2 {
    padding-left: 1rem;
}

.sticky-toc .TOC3 {
    padding-left: 2rem;
}

/* Smooth scrolling */
html {
    scroll-behavior: smooth;
}

.content-preview h1,
.content-preview h2,
.content-preview h3 {
    scroll-margin-top: 80px;
}

/* Hide sticky TOC on mobile */
@media (max-width: 991px) {
    .sticky-toc-sidebar {
        display: none;
    }
}

@media (max-width: 768px) {
    .doc-title {
        font-size: 1.5rem;
    }
}
{% endblock %}

{% block content %}
<a href="{{ url_for('policy_library.index') }}" class="back-link">← Browse</a>

<h1 class="doc-title">{{ document.title }}</h1>

<!-- Minimal metadata block - everything combined -->
<div class="metadata">
    <div class="metadata-line">
        <span class="source-badge" data-source="{{ document.source.source_code if document.source else 'UNKNOWN' }}">
            {{ document.source.name if document.source else 'Unknown Source' }}
        </span>
        · Published {{ document.publication_date or 'n.d.' }}
        {% if document.document_type %} · {{ document.document_type }}{% endif %}
        {% if document.document_identifier %} · {{ document.document_identifier }}{% endif %}
        {% if content_version and content_version.get('word_count') %}
        · {{ "{:,}".format(content_version['word_count']|int) }} words
        · ~{{ (content_version['word_count']|int / 200)|round|int }} min read
        {% elif document.word_count %}
        · {{ document.word_count|number_format or 0 }} words
        {% endif %}
        {% if document.page_count %} · {{ document.page_count }} pages{% endif %}
    </div>

    {% if authors %}
    <div class="metadata-line">
        {% for author in authors %}{{ author.full_name }}{% if not loop.last %}, {% endif %}{% endfor %}
    </div>
    {% endif %}

    <div class="metadata-line">
        {% if document.url %}
            <a href="{{ document.url }}" target="_blank" rel="noopener noreferrer">
                {{ source_config.link_text if source_config else 'View Original' }}
            </a>
        {% endif %}
        {% if document.url and document.pdf_url %} · {% endif %}
        {% if document.pdf_url %}<a href="{{ document.pdf_url }}" target="_blank" rel="noopener noreferrer">PDF</a>{% endif %}
    </div>
</div>

<!-- CRS Content with TOC -->
{% if content_version and content_version.get('html_content') %}
<div class="row">
    {# Check if HTML content contains a TOC div - JavaScript will handle the rest #}
    {% set has_toc = 'class="TOC"' in content_version['html_content'] or 'class=\'TOC\'' in content_version['html_content'] %}

    <div class="{% if has_toc %}col-lg-9{% else %}col-12{% endif %}">
        <div class="section">
            <div class="content-preview">
                {{ content_version['html_content']|safe }}
            </div>
        </div>
    </div>

    <!-- Sticky TOC Sidebar (always render for CRS docs, JavaScript will populate if TOC exists) -->
    {% if has_toc %}
    <div class="col-lg-3">
        <div class="sticky-toc-sidebar" id="sticky-toc-sidebar">
            <!-- TOC will be cloned here by JavaScript -->
        </div>
    </div>
    {% endif %}
</div>
{% else %}
<!-- Non-CRS content or CRS without HTML -->

<!-- Summary -->
{% if document.summary %}
<div class="section">
    <h2 class="section-title">Summary</h2>
    <p class="text-secondary">{{ document.summary }}</p>
</div>
{% endif %}

<!-- Full Text Preview -->
{% if document.full_text %}
<div class="section">
    <h2 class="section-title">Full Text</h2>
    <div class="content-preview" id="content-preview">
        <div id="preview-text">{{ document.full_text[:10000]|format_transcript }}{% if document.full_text|length > 10000 %}<p class="text-secondary" style="font-size: 0.9rem; margin-top: 1rem;">...</p>{% endif %}</div>
        {% if document.full_text|length > 10000 %}
        <div id="full-text" style="display: none;">{{ document.full_text|format_transcript }}</div>
        {% endif %}
    </div>
    {% if document.full_text|length > 10000 %}
    <button id="show-more-btn" class="show-more-btn" onclick="toggleFullText()">Show More</button>
    {% endif %}
</div>
{% elif document.source and document.source.source_code == 'CRS' %}
<!-- CRS document without HTML content yet -->
<div class="section">
    <p class="text-secondary">Full content not yet available.</p>
</div>
{% endif %}

{% endif %}

<!-- Document ID (for reference) -->
<div class="mt-4">
    <p class="text-secondary" style="font-size: 0.85rem;">Document ID: {{ document.document_identifier }}</p>
</div>
{% endblock %}

{% block scripts %}
<script>
// Setup floating TOC for CRS documents
document.addEventListener('DOMContentLoaded', function() {
    const originalToc = document.querySelector('.content-preview .TOC');
    const sidebar = document.getElementById('sticky-toc-sidebar');

    if (originalToc && sidebar) {
        // Create sticky TOC
        const stickyTocDiv = document.createElement('div');
        stickyTocDiv.className = 'sticky-toc';

        // Add header
        const header = document.createElement('h2');
        header.textContent = 'Contents';
        stickyTocDiv.appendChild(header);

        // Clone TOC content
        const tocContent = originalToc.cloneNode(true);
        // Remove the h1 "Contents" heading from cloned version
        const h1 = tocContent.querySelector('h1');
        if (h1) h1.remove();

        stickyTocDiv.appendChild(tocContent);
        sidebar.appendChild(stickyTocDiv);

        // Scroll spy - highlight current section
        const tocLinks = stickyTocDiv.querySelectorAll('a');
        const sections = [];

        tocLinks.forEach(link => {
            const href = link.getAttribute('href');
            if (href && href.startsWith('#')) {
                const targetId = href.substring(1);
                const target = document.querySelector(`[name="${targetId}"], #${targetId}`);
                if (target) {
                    sections.push({ link: link, element: target });
                }
            }
        });

        function updateActiveSection() {
            const scrollPosition = window.scrollY + 100;

            let currentSection = null;
            sections.forEach(section => {
                const rect = section.element.getBoundingClientRect();
                const elementTop = rect.top + window.scrollY;

                if (scrollPosition >= elementTop) {
                    currentSection = section;
                }
            });

            tocLinks.forEach(link => link.classList.remove('active'));
            if (currentSection) {
                currentSection.link.classList.add('active');
            }
        }

        window.addEventListener('scroll', updateActiveSection);
        updateActiveSection();
    }

    // Handle broken images from Congress.gov (they require authentication)
    const images = document.querySelectorAll('.content-preview img');
    images.forEach(img => {
        img.onerror = function() {
            // Create a fallback placeholder
            const fallback = document.createElement('div');
            fallback.className = 'image-fallback';
            fallback.style.cssText = 'padding: 2rem; background-color: #f8f9fa; border: 2px dashed #dee2e6; text-align: center; font-size: 0.9rem; color: #6c757d; margin: 2rem 0; border-radius: 4px;';

            const title = this.getAttribute('title') || this.getAttribute('alt') || 'Figure';
            const originalSrc = this.getAttribute('data-original-src') || '';

            fallback.innerHTML = `
                <div style="padding: 1rem;">
                    <p style="margin: 0 0 0.5rem 0; font-weight: 500;">${title}</p>
                    <p style="margin: 0; font-size: 0.85rem; color: #999;">
                        Image unavailable (requires Congress.gov authentication)
                    </p>
                    ${originalSrc ? `<p style="margin: 0.5rem 0 0 0; font-size: 0.75rem; color: #999;">Reference: ${originalSrc}</p>` : ''}
                </div>
            `;

            this.parentNode.replaceChild(fallback, this);
        };
    });
});

function toggleFullText() {
    const previewText = document.getElementById('preview-text');
    const fullText = document.getElementById('full-text');
    const btn = document.getElementById('show-more-btn');

    if (fullText && fullText.style.display === 'none') {
        // Show full text
        previewText.style.display = 'none';
        fullText.style.display = 'block';
        btn.textContent = 'Show Less';
    } else if (fullText) {
        // Show preview
        previewText.style.display = 'block';
        fullText.style.display = 'none';
        btn.textContent = 'Show More';
        // Scroll back to content start
        document.getElementById('content-preview').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

// Handle iframe resizing messages (for Datawrapper and similar embeds)
window.addEventListener('message', function(e) {
    let data = e.data;

    // Handle both string and object messages
    if (typeof data === 'string') {
        try {
            data = JSON.parse(data);
        } catch (err) {
            // Not JSON, ignore
            return;
        }
    }

    // Check if this is a Datawrapper height message
    if (data && data['datawrapper-height']) {
        const iframes = document.querySelectorAll('.interactive-chart-container iframe');

        for (const chartId in data['datawrapper-height']) {
            const height = data['datawrapper-height'][chartId];

            // Find iframe that contains this chart ID in its src
            for (let i = 0; i < iframes.length; i++) {
                if (iframes[i].src && iframes[i].src.indexOf(chartId) > -1) {
                    iframes[i].style.height = height + 'px';
                    console.log('Updated iframe height for', chartId, 'to', height + 'px');
                }
            }
        }
    }
});
</script>
{% endblock %}
