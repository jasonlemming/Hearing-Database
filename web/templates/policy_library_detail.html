{% extends "policy_library_base.html" %}

{% block title %}{{ document.title }}{% endblock %}

{% block head_style %}
/* Back link */
.back-link {
    font-size: 0.9rem;
    color: #6c757d;
    text-decoration: none;
    display: inline-block;
    margin-bottom: 3rem;
}

.back-link:hover {
    color: #0d6efd;
    text-decoration: none;
}

/* Document title */
.doc-title {
    font-size: 2rem;
    font-weight: 500;
    line-height: 1.3;
    margin-bottom: 1rem;
    color: #1a1a1a;
}

/* Metadata section - minimal, all in one block */
.metadata {
    font-size: 0.95rem;
    color: #6c757d;
    margin-bottom: 3rem;
    line-height: 1.8;
}

.metadata-line {
    margin-bottom: 0.5rem;
}

.metadata a {
    color: inherit;
    text-decoration: none;
    transition: color 0.2s ease;
}

.metadata a:hover {
    color: #1a1a1a;
    text-decoration: underline;
}

/* Content - Georgia serif */
.section {
    margin-bottom: 4rem;
}

.section-title {
    font-size: 1.25rem;
    font-weight: 500;
    margin-bottom: 1rem;
    color: #1a1a1a;
}

.content-preview {
    font-family: Georgia, serif;
    font-size: 1.05rem;
    line-height: 1.8;
    color: #1a1a1a;
}

.content-preview p {
    margin-bottom: 1.2rem;
}

.content-preview em {
    font-style: italic;
}

.content-preview .speaker-line {
    margin-bottom: 0.8rem;
}

.content-preview .speaker-label {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    font-weight: 600;
    font-size: 0.95rem;
    color: #0d6efd;
    letter-spacing: 0.5px;
    margin-right: 0.5rem;
}

.external-link {
    display: inline-block;
    margin-right: 1.5rem;
    margin-top: 0.5rem;
}

.show-more-btn {
    font-family: inherit;
    font-size: 0.9rem;
    padding: 0.75rem 1.5rem;
    background: #f8f9fa;
    color: #1a1a1a;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    cursor: pointer;
    margin-top: 2rem;
    transition: all 0.3s ease;
}

.show-more-btn:hover {
    background: #1a1a1a;
    color: #ffffff;
    border-color: #1a1a1a;
}

.content-preview .content-heading {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    font-weight: 500;
    color: #1a1a1a;
    margin-top: 2.5rem;
    margin-bottom: 1rem;
    line-height: 1.3;
}

.content-preview .content-h2 {
    font-size: 1.5rem;
    margin-top: 3rem;
}

.content-preview .content-h3 {
    font-size: 1.25rem;
    margin-top: 2rem;
}

.content-preview .content-h4 {
    font-size: 1.1rem;
}

.content-preview .content-h5,
.content-preview .content-h6 {
    font-size: 1rem;
}

.content-preview .content-table {
    width: 100%;
    border-collapse: collapse;
    margin: 2rem 0;
    font-size: 0.95rem;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
}

.content-preview .content-table thead th {
    background-color: #f8f9fa;
    font-weight: 600;
    text-align: left;
    padding: 0.75rem 1rem;
    border-bottom: 2px solid #dee2e6;
}

.content-preview .content-table tbody td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #e9ecef;
}

.content-preview .content-table tbody tr:hover {
    background-color: #f8f9fa;
}

.content-preview .content-table tbody tr:last-child td {
    border-bottom: none;
}

.content-preview .content-figure {
    margin: 2rem 0;
    padding: 1.5rem;
    background-color: #f8f9fa;
    border-left: 4px solid #0d6efd;
    border-radius: 4px;
}

.content-preview .figure-label {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    font-weight: 600;
    font-size: 0.95rem;
    color: #0d6efd;
    margin-bottom: 0.5rem;
}

.content-preview .figure-description {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    font-size: 0.95rem;
    color: #495057;
    line-height: 1.6;
}

.content-preview .figure-source {
    font-size: 0.85rem;
    margin-top: 0.5rem;
}

.content-preview .figure-source a {
    color: #0d6efd;
    text-decoration: none;
}

.content-preview .figure-source a:hover {
    text-decoration: underline;
}

.content-preview .interactive-chart-container {
    margin: 2rem 0;
    padding: 0;
    background-color: #ffffff;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    overflow: visible;
    min-height: 400px;
}

.content-preview .interactive-chart-container iframe {
    display: block;
    width: 100%;
    max-width: 100%;
    border: none;
    overflow: hidden;
}

/* Source badges */
.source-badge {
    display: inline-block;
    padding: 0.2rem 0.6rem;
    font-size: 0.8rem;
    font-weight: 500;
    border-radius: 3px;
    text-transform: uppercase;
    letter-spacing: 0.025em;
}

.source-badge[data-source="BROOKINGS"] {
    background: #e3f2fd;
    color: #1976d2;
}

.source-badge[data-source="SUBSTACK"] {
    background: #fff3e0;
    color: #e65100;
}

.source-badge[data-source="CRS"] {
    background: #f3e5f5;
    color: #7b1fa2;
}

.source-badge[data-source="GAO"] {
    background: #e8f5e9;
    color: #2e7d32;
}

.source-badge[data-source="UNKNOWN"] {
    background: #f5f5f5;
    color: #757575;
}

@media (max-width: 768px) {
    .doc-title {
        font-size: 1.5rem;
    }
}
{% endblock %}

{% block content %}
<a href="{{ url_for('policy_library.index') }}" class="back-link">← Browse</a>

<h1 class="doc-title">{{ document.title }}</h1>

<!-- Minimal metadata block - everything combined -->
<div class="metadata">
    <div class="metadata-line">
        <span class="source-badge" data-source="{{ document.source.source_code if document.source else 'UNKNOWN' }}">
            {{ document.source.name if document.source else 'Unknown Source' }}
        </span>
        · Published {{ document.publication_date or 'n.d.' }}
        {% if document.document_type %} · {{ document.document_type }}{% endif %}
        · {{ document.word_count|number_format or 0 }} words
        {% if document.page_count %} · {{ document.page_count }} pages{% endif %}
    </div>

    {% if authors %}
    <div class="metadata-line">
        {% for author in authors %}{{ author.full_name }}{% if not loop.last %}, {% endif %}{% endfor %}
    </div>
    {% endif %}

    <div class="metadata-line">
        {% if document.url %}
            <a href="{{ document.url }}" target="_blank" rel="noopener noreferrer">
                {{ source_config.link_text if source_config else 'View Original' }}
            </a>
        {% endif %}
        {% if document.url and document.pdf_url %} · {% endif %}
        {% if document.pdf_url %}<a href="{{ document.pdf_url }}" target="_blank" rel="noopener noreferrer">PDF</a>{% endif %}
    </div>
</div>

<!-- Summary -->
{% if document.summary %}
<div class="section">
    <h2 class="section-title">Summary</h2>
    <p class="text-secondary">{{ document.summary }}</p>
</div>
{% endif %}

<!-- Full Text Preview -->
{% if document.full_text %}
<div class="section">
    <h2 class="section-title">Full Text</h2>
    <div class="content-preview" id="content-preview">
        <div id="preview-text">{{ document.full_text[:10000]|format_transcript }}{% if document.full_text|length > 10000 %}<p class="text-secondary" style="font-size: 0.9rem; margin-top: 1rem;">...</p>{% endif %}</div>
        {% if document.full_text|length > 10000 %}
        <div id="full-text" style="display: none;">{{ document.full_text|format_transcript }}</div>
        {% endif %}
    </div>
    {% if document.full_text|length > 10000 %}
    <button id="show-more-btn" class="show-more-btn" onclick="toggleFullText()">Show More</button>
    {% endif %}
</div>
{% endif %}

<!-- Document ID (for reference) -->
<div class="mt-4">
    <p class="text-secondary" style="font-size: 0.85rem;">Document ID: {{ document.document_identifier }}</p>
</div>
{% endblock %}

{% block scripts %}
<script>
function toggleFullText() {
    const previewText = document.getElementById('preview-text');
    const fullText = document.getElementById('full-text');
    const btn = document.getElementById('show-more-btn');

    if (fullText.style.display === 'none') {
        // Show full text
        previewText.style.display = 'none';
        fullText.style.display = 'block';
        btn.textContent = 'Show Less';
    } else {
        // Show preview
        previewText.style.display = 'block';
        fullText.style.display = 'none';
        btn.textContent = 'Show More';
        // Scroll back to content start
        document.getElementById('content-preview').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

// Handle iframe resizing messages (for Datawrapper and similar embeds)
window.addEventListener('message', function(e) {
    let data = e.data;

    // Handle both string and object messages
    if (typeof data === 'string') {
        try {
            data = JSON.parse(data);
        } catch (err) {
            // Not JSON, ignore
            return;
        }
    }

    // Check if this is a Datawrapper height message
    if (data && data['datawrapper-height']) {
        const iframes = document.querySelectorAll('.interactive-chart-container iframe');

        for (const chartId in data['datawrapper-height']) {
            const height = data['datawrapper-height'][chartId];

            // Find iframe that contains this chart ID in its src
            for (let i = 0; i < iframes.length; i++) {
                if (iframes[i].src && iframes[i].src.indexOf(chartId) > -1) {
                    iframes[i].style.height = height + 'px';
                    console.log('Updated iframe height for', chartId, 'to', height + 'px');
                }
            }
        }
    }
});
</script>
{% endblock %}
